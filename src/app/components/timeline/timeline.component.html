<div class="timeline-container">
  <!-- Header -->
  <header class="timeline-header">
    <div class="logo">
      <span class="logo-nao">NAO</span><span class="logo-logic">LOGIC</span>
    </div>
  </header>

  <!-- Title -->
  <div class="timeline-title-section">
    <h1 class="timeline-title">Work Orders</h1>
  </div>

  <!-- Timescale Controls -->
  <div class="timeline-controls">
    <span class="timescale-label">Timescale</span>
    <ng-select
      [(ngModel)]="currentTimescale"
      [items]="timescaleOptions"
      bindLabel="label"
      bindValue="value"
      [clearable]="false"
      [searchable]="false"
      class="timescale-select"
    >
    </ng-select>
  </div>

  <!-- Timeline Grid (CSS Grid: 2x2) -->
  <div class="timeline-grid">
    <!-- Top-Left: Work Centers Header -->
    <div class="work-centers-header">
      <span>Work Center</span>
    </div>

    <!-- Top-Right: Timeline Header -->
    <div class="timeline-header-row" #timelineHeader>
      @for (column of columns(); track trackByColumn($index, column)) {
        <div
          class="timeline-column-header"
          [style.width.px]="timelineService.columnWidth()"
        >
          <span class="column-label">{{ column.label }}</span>
        </div>
      }
    </div>

    <!-- Bottom-Left: Work Centers List -->
    <div class="work-centers-list" #workCentersList>
      @for (workCenter of workOrderService.workCenters(); track trackByWorkCenter($index, workCenter)) {
        <div
          class="work-center-row"
          [class.hovered]="hoveredRowId() === workCenter.docId"
          (mouseenter)="onRowMouseEnter(workCenter.docId)"
          (mouseleave)="onRowMouseLeave()"
        >
          <span class="work-center-name">{{ workCenter.data.name }}</span>
        </div>
      }
    </div>

    <!-- Bottom-Right: Timeline Content -->
    <div class="timeline-content" #timelineContent (scroll)="onTimelineScroll($event)">
      <div class="timeline-inner" [style.width.px]="totalWidth()">
        <!-- Column dividers (full height vertical lines) -->
        @for (column of columns(); track trackByColumn($index, column); let i = $index) {
          <div 
            class="column-divider"
            [class.current-month-divider]="column.isCurrentPeriod"
            [style.left.px]="i * timelineService.columnWidth()"
          ></div>
        }

        <!-- Current Month Badge -->
        @if (currentPeriodBadgePosition() !== null) {
          <div 
            class="current-period-badge"
            [style.left.px]="currentPeriodBadgePosition()"
          >
            Current month
          </div>
        }

        <!-- Timeline Rows -->
        <div class="timeline-rows">
          @for (workCenter of workOrderService.workCenters(); track trackByWorkCenter($index, workCenter)) {
            <div
              class="timeline-row"
              [class.hovered]="hoveredRowId() === workCenter.docId"
              (mouseenter)="onRowMouseEnter(workCenter.docId)"
              (mouseleave)="onRowMouseLeave()"
            >
              <div
                class="timeline-row-content"
                (click)="onTimelineClick($event, workCenter)"
                (mousemove)="onTimelineMouseMove($event, workCenter.docId)"
                (mouseleave)="onTimelineMouseLeave()"
              >

                <!-- Hover placeholder -->
                @if (hoverPlaceholder() && hoverPlaceholder()!.workCenterId === workCenter.docId) {
                  <div
                    class="hover-placeholder"
                    [style.left.px]="hoverPlaceholder()!.left"
                    [style.width.px]="hoverPlaceholder()!.width"
                  ></div>
                }

                <!-- Work Order Bars -->
                @for (workOrder of getWorkOrdersForCenter(workCenter.docId); track trackByWorkOrder($index, workOrder)) {
                  <app-work-order-bar
                    [workOrder]="workOrder"
                    [left]="getBarLeft(workOrder)"
                    [width]="getBarWidth(workOrder)"
                    (edit)="onEditWorkOrder($event)"
                    (delete)="onDeleteWorkOrder($event)"
                  />
                }

              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tooltip -->
@if (showTooltip()) {
  <div
    class="click-tooltip"
    [style.left.px]="tooltipPosition().x"
    [style.top.px]="tooltipPosition().y"
  >
    Click to add dates
  </div>
}

<!-- Work Order Panel -->
<app-work-order-panel
  [isOpen]="isPanelOpen()"
  [mode]="panelMode()"
  [workOrder]="selectedWorkOrder()"
  [workCenterId]="selectedWorkCenterId()"
  [initialStartDate]="initialStartDate()"
  [errorMessage]="panelError()"
  [existingWorkOrders]="workOrderService.workOrders()"
  (close)="onPanelClose()"
  (save)="onPanelSave($event)"
/>
